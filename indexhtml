<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æˆ‘çš„æ—¶å…‰ (Smart Sync)</title>
    <style>
        :root {
            --bg-color: #f5f7fa; --text-primary: #2c3e50; --text-secondary: #607d8b;
            --glass-bg: rgba(255, 255, 255, 0.85); --glass-border: rgba(255, 255, 255, 0.5);
            --accent-color: #d35400; --danger-color: #e74c3c; --success-color: #27ae60;
            --card-radius: 20px; --shadow: 0 8px 30px rgba(0,0,0,0.08);
            --mood-happy: #f1c40f; --mood-calm: #3498db; --mood-normal: #95a5a6; --mood-tired: #9b59b6; --mood-sad: #34495e;
            --font-family: "Noto Serif SC", "Songti SC", serif;
        }
        body.theme-dark { --bg-color: #1a1a2e; --text-primary: #ecf0f1; --text-secondary: #bdc3c7; --glass-bg: rgba(30, 30, 50, 0.85); --glass-border: rgba(255, 255, 255, 0.1); --accent-color: #e94560; }
        body.theme-monet { --bg-color: #e8f1f2; --bg-image: linear-gradient(135deg, #e8f1f2, #ffe4e1); --glass-bg: rgba(255, 255, 255, 0.65); --accent-color: #7b9acc; }
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: var(--font-family); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: var(--bg-color); color: var(--text-primary); transition: all 0.5s ease; background-size: cover; background-position: center; background-attachment: fixed; }
        .bg-overlay { position: fixed; inset: 0; z-index: -1; transition: background 0.3s; }
        body.has-custom-bg .bg-overlay { background: rgba(0,0,0,0.2); backdrop-filter: blur(3px); }

        .icon-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 50%; width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; cursor: pointer; backdrop-filter: blur(5px); font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .top-bar { position: absolute; top: 15px; right: 20px; z-index: 100; display: flex; gap: 10px; }
        
        .main-wrapper { flex: 1; width: 100%; max-width: 1400px; margin: 0 auto; padding: 60px 20px 20px 20px; display: grid; gap: 20px; grid-template-columns: 1fr; grid-template-rows: auto 1fr; overflow-y: auto; }
        @media (min-width: 900px) { .main-wrapper { grid-template-columns: 1.4fr 1fr; grid-template-rows: 1fr; overflow: hidden; align-items: stretch; padding-top: 100px; } }

        .glass-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--card-radius); box-shadow: var(--shadow); padding: 20px; display: flex; flex-direction: column; backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); transition: 0.3s; }
        
        .calendar-container { height: 100%; min-height: 400px; overflow-y: auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: 700; font-size: 1.2rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .day-name { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; }
        .calendar-day { min-height: 70px; border-radius: 12px; background: rgba(255,255,255,0.2); cursor: pointer; display: flex; flex-direction: column; align-items: center; padding-top: 5px; position: relative; transition: 0.2s; }
        .calendar-day.today { background: var(--text-primary); color: var(--bg-color); font-weight: bold; }
        .day-stats { display: flex; gap: 3px; margin-top: auto; margin-bottom: 5px; }
        .stat-badge { width: 6px; height: 6px; border-radius: 50%; }
        
        header { position: absolute; top: 0; width: 100%; text-align: center; padding-top: 10px; pointer-events: none; }
        .flip-clock { display: inline-flex; gap: 5px; pointer-events: auto; }
        .flip-card { background: var(--text-primary); color: var(--bg-color); padding: 4px 6px; border-radius: 4px; font-size: 1.5rem; font-weight: 700; min-width: 35px; }
        .flip-card.seconds { background: var(--accent-color); font-size: 1.2rem; min-width: 28px; padding: 6px 4px; }
        
        .right-column { display: flex; flex-direction: column; gap: 15px; height: 100%; overflow: hidden; min-height: 400px; }
        .countdown-card { min-height: 100px; justify-content: center; text-align: center; flex-shrink: 0; position: relative; }
        .countdown-nav { position: absolute; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); opacity: 0.3; cursor: pointer; padding: 10px; }
        .countdown-days { font-size: 2.5rem; font-weight: 800; color: var(--accent-color); line-height: 1; }
        
        .overview-card { flex: 1; min-height: 0; }
        .overview-title { font-weight: 700; border-left: 4px solid var(--accent-color); padding-left: 10px; margin-bottom: 10px; }
        .overview-list-container { overflow-y: auto; flex: 1; }
        .overview-task-item { background: rgba(255,255,255,0.4); padding: 8px; border-radius: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; cursor: pointer; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; }
        .modal-content { background: var(--glass-bg); width: 100%; max-width: 550px; height: 85vh; border-radius: 20px; display: flex; flex-direction: column; transform: translateY(20px); transition: 0.3s; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        @media(max-width: 600px) { .modal-content { border-radius: 20px 20px 0 0; height: 92vh; position: absolute; bottom: 0; transform: translateY(100%); } .modal-overlay.active .modal-content { transform: translateY(0); } }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .sections-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        input, textarea { width: 100%; padding: 10px; border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(255,255,255,0.5); outline: none; font-family: inherit; }
        .input-group { display: flex; gap: 8px; }
        .add-btn { width: 40px; background: var(--text-primary); color: #fff; border: none; border-radius: 8px; cursor: pointer; }
        
        .task-item, .thought-item, .schedule-item { background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .thought-item { flex-direction: column; align-items: flex-start; }
        .done-list .task-item { opacity: 0.6; text-decoration: line-through; }
        .action-btn { background: none; border: none; cursor: pointer; opacity: 0.5; margin-left: 5px; font-size: 1rem; }
        .action-btn:hover { opacity: 1; color: var(--danger-color); }
        
        .settings-group { margin-bottom: 20px; background: rgba(0,0,0,0.03); padding: 15px; border-radius: 12px; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 5px; }
        .status-dot.online { background: #27ae60; box-shadow: 0 0 5px #27ae60; }
        .status-dot.error { background: #e74c3c; box-shadow: 0 0 5px #e74c3c; }
    </style>
</head>
<body>
    <div class="bg-overlay"></div>

    <header>
        <div class="flip-clock">
            <div class="flip-card" id="h">00</div><div class="flip-card" id="m">00</div><div class="flip-card seconds" id="s">00</div>
        </div>
        <div id="date-display">...</div>
    </header>

    <div class="top-bar">
        <div id="sync-status" class="icon-btn" title="åŒæ­¥çŠ¶æ€" style="width: auto; padding: 0 10px; font-size: 0.8rem; gap: 5px;">
            <span class="status-dot"></span> <span id="sync-text">ç¦»çº¿</span>
        </div>
        <button class="icon-btn" onclick="openSettings()">âš™ï¸</button>
    </div>

    <div class="main-wrapper">
        <div class="glass-card calendar-container">
            <div class="calendar-header">
                <button class="nav-btn icon-btn" onclick="goToday()">ä»Š</button>
                <span id="month-year">...</span>
                <div>
                    <button class="nav-btn icon-btn" onclick="changeMonth(-1)">â®</button>
                    <button class="nav-btn icon-btn" onclick="changeMonth(1)" style="margin-left:5px;">â¯</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <div class="right-column">
            <div class="glass-card countdown-card">
                <button class="countdown-nav cd-prev" style="left:5px" onclick="switchCd(-1)">â€¹</button>
                <div onclick="openSettings()">
                    <div class="countdown-title" id="cd-title">...</div>
                    <div class="countdown-days" id="cd-days">0</div>
                    <div class="countdown-target" id="cd-target">...</div>
                </div>
                <button class="countdown-nav cd-next" style="right:5px" onclick="switchCd(1)">â€º</button>
            </div>
            
            <div class="glass-card overview-card">
                <div class="overview-title">ğŸ“‹ å¾…åŠæ¦‚è§ˆ</div>
                <div class="overview-list-container" id="overview-tasks"></div>
            </div>
            
            <div class="glass-card overview-card">
                <div class="overview-title">ğŸ“… æ—¥ç¨‹æ¦‚è§ˆ</div>
                <div class="overview-list-container" id="overview-schedules"></div>
            </div>
        </div>
    </div>

    <div class="footer-quote" id="footer-quote" onclick="updateQuote()"></div>

    <!-- Day Modal -->
    <div class="modal-overlay" id="day-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div><span id="sel-date" style="font-size:1.8rem;font-weight:700"></span> <span id="sel-day" style="color:var(--text-secondary)"></span></div>
                <button class="close-btn" onclick="closeModal('day-modal')">Ã—</button>
            </div>
            <div class="mood-section" style="padding: 0 20px 10px; display:flex; gap:15px; border-bottom:1px solid var(--glass-border);">
                <div class="mood-btn" onclick="setMood('happy')" style="font-size:1.8rem; cursor:pointer; opacity:0.5;">ğŸ˜„</div>
                <div class="mood-btn" onclick="setMood('calm')" style="font-size:1.8rem; cursor:pointer; opacity:0.5;">ğŸ˜Œ</div>
                <div class="mood-btn" onclick="setMood('normal')" style="font-size:1.8rem; cursor:pointer; opacity:0.5;">ğŸ˜</div>
                <div class="mood-btn" onclick="setMood('tired')" style="font-size:1.8rem; cursor:pointer; opacity:0.5;">ğŸ˜«</div>
                <div class="mood-btn" onclick="setMood('sad')" style="font-size:1.8rem; cursor:pointer; opacity:0.5;">ğŸ˜¢</div>
            </div>
            <div class="sections-container">
                <div>
                    <div class="section-title">ğŸ“… æ—¥ç¨‹</div>
                    <div class="input-group">
                        <input type="time" id="new-sche-time" style="flex:0.4">
                        <input type="text" id="new-sche-text" placeholder="æ—¥ç¨‹å®‰æ’...">
                        <button class="add-btn" onclick="addSche()">ï¼‹</button>
                    </div>
                    <div id="sche-list"></div>
                </div>
                <div>
                    <div class="section-title">âœ… å¾…åŠ</div>
                    <div class="input-group">
                        <input type="text" id="new-todo-text" placeholder="æƒ³åšä»€ä¹ˆ...">
                        <button class="add-btn" onclick="addTodo()">ï¼‹</button>
                    </div>
                    <div id="todo-list"></div>
                    <div id="done-list" class="done-list" style="margin-top:10px;"></div>
                </div>
                <div>
                    <div class="section-title">ğŸ“ éšç¬”</div>
                    <div class="input-group">
                        <input id="new-thought-text" placeholder="è®°å½•æ­¤åˆ»...">
                        <button class="add-btn" onclick="addThought()">âœ</button>
                    </div>
                    <div id="thought-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content" style="height: auto; max-height: 90vh;">
            <div class="modal-header"><h2>è®¾ç½®</h2><button class="close-btn" onclick="closeModal('settings-modal')">Ã—</button></div>
            <div class="sections-container">
                <!-- Cloud Sync (Smart Parse) -->
                <div class="settings-group" style="border-left: 4px solid var(--accent-color);">
                    <div style="font-weight:bold; margin-bottom:5px;">â˜ï¸ äº‘ç«¯åŒæ­¥é…ç½®</div>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">è¯·ç²˜è´´æ‚¨çš„ Firebase Configã€‚æ”¯æŒç›´æ¥ç²˜è´´JSä»£ç ï¼Œæ— éœ€ä¿®æ”¹æ ¼å¼ã€‚</div>
                    <input type="text" id="cfg-sync-id" placeholder="åŒæ­¥å¯†é’¥ (Sync ID, ä»»æ„å­—ç¬¦)" style="margin-bottom:5px;">
                    <textarea id="cfg-firebase" placeholder='ä¾‹å¦‚: const firebaseConfig = { apiKey: "AIza..." };' style="height:100px; font-family:monospace; font-size:0.8rem;"></textarea>
                    <button onclick="saveCloudConfig()" style="width:100%; padding:10px; margin-top:5px; background:var(--text-primary); color:white; border:none; border-radius:6px; font-weight:bold;">ç«‹å³è¿æ¥</button>
                </div>

                <!-- Theme & BG -->
                <div class="settings-group">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ¨ å¤–è§‚</div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                        <button onclick="setTheme('white')" style="padding:5px 10px;">ç™½</button>
                        <button onclick="setTheme('dark')" style="padding:5px 10px; background:#333; color:white;">é»‘</button>
                        <button onclick="setTheme('monet')" style="padding:5px 10px; background:#e8f1f2;">è«å¥ˆ</button>
                    </div>
                    <input type="file" id="bg-upload" accept="image/*" onchange="uploadBg(event)">
                    <button onclick="clearBg()" style="margin-top:5px; color:red; background:none; border:none;">æ¸…é™¤èƒŒæ™¯</button>
                </div>

                <!-- Countdown -->
                <div class="settings-group">
                    <div style="font-weight:bold; margin-bottom:5px;">ğŸ‰ å€’æ•°æ—¥</div>
                    <div id="cd-list"></div>
                    <div class="input-group">
                        <input id="cd-name" placeholder="åç§°"><input type="date" id="cd-date">
                        <button class="add-btn" onclick="addCd()">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.db = null;
        window.syncId = localStorage.getItem('cal_sync_id') || '';
        let localData = JSON.parse(localStorage.getItem('cal_data_v4') || '{}');
        let settings = JSON.parse(localStorage.getItem('cal_settings_v4') || '{"theme":"white","countdowns":[]}');
        let curDate = new Date();
        let selKey = null;
        let curCdIdx = 0;
        let unsubscribe = null;

        const $ = id => document.getElementById(id);
        
        async function init() {
            applySettings(); updateClock(); setInterval(updateClock, 1000);
            renderCal(); renderOverviews(); renderCd();
            
            const fbCfgRaw = localStorage.getItem('cal_firebase_cfg_raw'); // Save raw string
            if(fbCfgRaw && window.syncId) {
                tryConfigAndConnect(fbCfgRaw);
            }
            
            $('new-todo-text').onkeypress = e => e.key==='Enter' && addTodo();
            $('new-sche-text').onkeypress = e => e.key==='Enter' && addSche();
            $('new-thought-text').onkeypress = e => e.key==='Enter' && addThought();
        }

        // Smart Config Parser
        function parseConfig(str) {
            try {
                // 1. Try strict JSON
                return JSON.parse(str);
            } catch (e) {
                try {
                    // 2. Try evaluating as JS object (handles unquoted keys, trailing commas)
                    // Security note: We trust the user's own config.
                    // Remove 'const firebaseConfig =' etc.
                    let clean = str.replace(/const\s+\w+\s*=\s*/, '').replace(/;$/, '');
                    return new Function('return ' + clean)();
                } catch (e2) {
                    console.error("Parse error", e2);
                    return null;
                }
            }
        }

        function tryConfigAndConnect(rawCfg) {
            const configObj = parseConfig(rawCfg);
            if (!configObj) {
                status('é…ç½®æ ¼å¼é”™è¯¯', false, true);
                return;
            }
            
            try {
                // If app already exists, delete it? No, just try-catch init
                const app = initializeApp(configObj);
                window.db = getFirestore(app);
                startSync();
            } catch(e) {
                // If error is "default app already exists", ignore it or reload
                if (e.code !== 'app/duplicate-app') {
                    console.error(e);
                    status('è¿æ¥å¤±è´¥: ' + e.message, false, true);
                }
            }
        }

        function getData(key) { return { schedules:[], todos:[], dones:[], thoughts:[], mood:null, ...localData[key] }; }

        function saveData(key, dayData) {
            localData[key] = dayData; persist(); renderCal(); renderOverviews();
            if(key === selKey) { renderList('sche'); renderList('todo'); renderList('thought'); renderMood(); }
        }

        function persist() {
            localStorage.setItem('cal_data_v4', JSON.stringify(localData));
            if(window.db && window.syncId) {
                setDoc(doc(window.db, 'calendars', window.syncId), { data: JSON.stringify(localData), updated: Date.now() })
                .catch(e => status('ä¸Šä¼ å¤±è´¥', false, true));
            }
        }

        function startSync() {
            status('è¿æ¥ä¸­...', false);
            if(unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(doc(window.db, 'calendars', window.syncId), (doc) => {
                if(doc.exists()) {
                    localData = JSON.parse(doc.data().data);
                    localStorage.setItem('cal_data_v4', JSON.stringify(localData));
                    renderCal(); renderOverviews(); renderCd();
                    if(selKey) { renderList('sche'); renderList('todo'); renderList('thought'); renderMood(); }
                    status('å·²åŒæ­¥', true);
                } else {
                    persist(); // Init cloud
                    status('å·²åˆå§‹åŒ–', true);
                }
            }, (err) => {
                console.error(err);
                if (err.code === 'permission-denied') status('æƒé™æ‹’ç»(è¯·æ£€æŸ¥Rules)', false, true);
                else status('ç¦»çº¿', false);
            });
        }

        function status(text, online, isError) {
            $('sync-text').innerText = text;
            const dot = $('sync-status').querySelector('.status-dot');
            dot.className = `status-dot ${online?'online':''} ${isError?'error':''}`;
        }

        window.saveCloudConfig = () => {
            const id = $('cfg-sync-id').value.trim();
            const raw = $('cfg-firebase').value.trim();
            if(id && raw) {
                localStorage.setItem('cal_sync_id', id);
                localStorage.setItem('cal_firebase_cfg_raw', raw); // Store raw input
                window.syncId = id;
                location.reload();
            } else {
                alert("è¯·å¡«å†™å®Œæ•´ Sync ID å’Œ Firebase Config");
            }
        };

        // --- UI Rendering ---
        window.renderCal = () => {
            const y = curDate.getFullYear(), m = curDate.getMonth();
            $('month-year').innerText = `${y}å¹´ ${m+1}æœˆ`;
            const grid = $('calendar-grid'); grid.innerHTML = '';
            ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => grid.innerHTML += `<div class="day-name">${d}</div>`);
            for(let i=0; i<new Date(y, m, 1).getDay(); i++) grid.appendChild(document.createElement('div'));
            const days = new Date(y, m+1, 0).getDate();
            const todayStr = new Date().toDateString();

            for(let i=1; i<=days; i++) {
                const date = new Date(y, m, i);
                const key = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const d = localData[key] || {};
                const el = document.createElement('div');
                el.className = `calendar-day ${date.toDateString() === todayStr ? 'today' : ''}`;
                let html = `<span>${i}</span>`;
                if(d.mood) html += `<div class="mood-indicator" style="background:var(--mood-${d.mood})"></div>`;
                const tc = d.todos?.length||0, dc = d.dones?.length||0;
                if(tc+dc > 0) html += `<div class="day-stats">${tc?`<div class="stat-badge stat-todo"></div>`:''}${dc?`<div class="stat-badge stat-done"></div>`:''}</div>`;
                el.innerHTML = html; el.onclick = () => openDay(key, date);
                grid.appendChild(el);
            }
        };
        
        window.changeMonth = d => { curDate.setMonth(curDate.getMonth()+d); renderCal(); };
        window.goToday = () => { curDate = new Date(); renderCal(); };

        window.openDay = (key, date) => {
            selKey = key;
            $('sel-date').innerText = date.getDate();
            $('sel-day').innerText = `${date.getFullYear()}.${date.getMonth()+1} / å‘¨${"æ—¥ä¸€äºŒä¸‰å››äº”å…­"[date.getDay()]}`;
            renderList('sche'); renderList('todo'); renderList('thought'); renderMood();
            $('day-modal').classList.add('active'); $('day-modal').style.display = 'flex';
        };

        window.renderMood = () => {
            const m = getData(selKey).mood;
            document.querySelectorAll('.mood-btn').forEach(b => {
                const active = b.onclick.toString().includes(`'${m}'`);
                b.style.opacity = active ? '1' : '0.5'; b.style.transform = active ? 'scale(1.2)' : 'scale(1)';
            });
        };
        window.setMood = (m) => { const d = getData(selKey); d.mood = (d.mood===m)?null:m; saveData(selKey, d); };

        window.renderList = (type) => {
            const d = getData(selKey);
            const list = d[type === 'todo' ? 'todos' : (type === 'sche' ? 'schedules' : 'thoughts')];
            const el = $(type + '-list'); el.innerHTML = '';

            if (type === 'sche') {
                list.sort((a,b) => (a.time||'').localeCompare(b.time||''));
                list.forEach((item, i) => {
                    el.innerHTML += `<div class="schedule-item"><span class="schedule-badge ${item.time?'':'tbd'}">${item.time||'å¾…å®š'}</span><span style="flex:1">${item.text}</span><button class="action-btn" onclick="delItem('sche',${i})">Ã—</button></div>`;
                });
            } else if (type === 'todo') {
                list.forEach((t, i) => el.innerHTML += `<div class="task-item"><span>${t}</span><div><button class="action-btn" onclick="finTask(${i})" style="color:var(--success-color)">âœ“</button><button class="action-btn" onclick="delItem('todo',${i})">Ã—</button></div></div>`);
                $('done-list').innerHTML = d.dones.map((t,i) => `<div class="task-item"><span>${t}</span><button class="action-btn" onclick="undoTask(${i})">â†©</button></div>`).join('');
            } else {
                list.forEach((t, i) => el.innerHTML += `<div class="thought-item"><div class="thought-time">${t.time}</div><div class="thought-body">${t.text}</div><button class="action-btn" style="position:absolute;top:5px;right:5px" onclick="delItem('thought',${t.id})">Ã—</button></div>`);
            }
        };

        window.addSche = () => { const t=$('new-sche-time').value, x=$('new-sche-text').value; if(x){ const d=getData(selKey); d.schedules.push({time:t,text:x}); saveData(selKey,d); $('new-sche-text').value=''; } };
        window.addTodo = () => { const x=$('new-todo-text').value; if(x){ const d=getData(selKey); d.todos.push(x); saveData(selKey,d); $('new-todo-text').value=''; } };
        window.addThought = () => { const x=$('new-thought-text').value; if(x){ const d=getData(selKey); d.thoughts.push({id:Date.now(), text:x, time:new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}); saveData(selKey,d); $('new-thought-text').value=''; } };

        window.delItem = (type, id) => {
            const d = getData(selKey);
            if(type==='thought') d.thoughts = d.thoughts.filter(t=>t.id!==id);
            else if(type==='sche') d.schedules.splice(id,1);
            else if(type==='todo') d.todos.splice(id,1);
            saveData(selKey, d);
        };
        window.finTask = i => { const d=getData(selKey); d.dones.unshift(d.todos.splice(i,1)[0]); saveData(selKey,d); };
        window.undoTask = i => { const d=getData(selKey); d.todos.push(d.dones.splice(i,1)[0]); saveData(selKey,d); };

        window.renderOverviews = () => {
            const today = new Date(); today.setHours(0,0,0,0);
            let tasks=[], sches=[];
            Object.keys(localData).forEach(k => {
                const [y,m,d] = k.split('-').map(Number);
                const date = new Date(y,m-1,d);
                const data = localData[k];
                if(data.todos) data.todos.forEach(t => tasks.push({t, k, date, ds:`${m}/${d}`}));
                if(data.schedules) data.schedules.forEach(s => sches.push({s, k, date, ds:`${m}/${d}`}));
            });
            const render = (c, arr, type) => {
                arr.sort((a,b) => a.date - b.date);
                const future = arr.filter(i => i.date >= today);
                if(!future.length) { $(c).innerHTML = '<div class="overview-empty">æ— å®‰æ’</div>'; return; }
                $(c).innerHTML = future.map(i => {
                    const content = type==='task' ? i.t : `<span class="schedule-badge ${i.s.time?'':'tbd'}">${i.s.time||'å¾…å®š'}</span> ${i.s.text}`;
                    return `<div class="overview-task-item" onclick="openDay('${i.k}', new Date('${i.date}'))"><div>${content}</div><span class="task-date-tag">${i.ds}</span></div>`;
                }).join('');
            };
            render('overview-tasks', tasks, 'task'); render('overview-schedules', sches, 'sche');
        };

        window.closeModal = id => { $(id).style.display='none'; $(id).classList.remove('active'); };
        window.openSettings = () => { 
            $('settings-modal').style.display='flex'; setTimeout(()=>$('settings-modal').classList.add('active'),10); 
            $('cfg-sync-id').value = window.syncId; $('cfg-firebase').value = localStorage.getItem('cal_firebase_cfg_raw') || '';
            renderCdSettings();
        };
        
        window.setTheme = t => { settings.theme=t; applySettings(); };
        window.applySettings = () => {
            document.body.className = `theme-${settings.theme}`;
            if(settings.bg) { document.body.style.backgroundImage=`url('${settings.bg}')`; document.body.classList.add('has-custom-bg'); }
            else { document.body.style.backgroundImage=''; }
            localStorage.setItem('cal_settings_v4', JSON.stringify(settings));
        };
        window.uploadBg = e => {
            const r = new FileReader(); r.onload=evt=> { settings.bg=evt.target.result; applySettings(); };
            if(e.target.files[0]) r.readAsDataURL(e.target.files[0]);
        };
        window.clearBg = () => { settings.bg=''; applySettings(); };

        window.renderCd = () => {
            const cds = settings.countdowns || [];
            const elT=$('cd-title'), elD=$('cd-days'), elTa=$('cd-target');
            if(!cds.length) { elT.innerText='æœªè®¾ç½®'; elD.innerText='0'; elTa.innerText='ç‚¹å‡»è®¾ç½®'; return; }
            if(curCdIdx>=cds.length) curCdIdx=0;
            const cd = cds[curCdIdx];
            const diff = Math.ceil((new Date(cd.date)-new Date().setHours(0,0,0,0))/(86400000));
            elT.innerText = `è·ç¦» ${cd.name}`;
            elD.innerHTML = diff>0 ? diff : (diff===0 ? 'ä»Šå¤©!' : Math.abs(diff));
            elTa.innerText = `${cd.date}`;
        };
        window.switchCd = d => { curCdIdx+=d; renderCd(); };
        window.renderCdSettings = () => { $('cd-list').innerHTML = (settings.countdowns||[]).map((c,i)=>`<div>${c.name} <button onclick="delCd(${i})">x</button></div>`).join(''); };
        window.addCd = () => { settings.countdowns = settings.countdowns || []; settings.countdowns.push({name:$('cd-name').value, date:$('cd-date').value}); applySettings(); renderCdSettings(); renderCd(); };
        window.delCd = i => { settings.countdowns.splice(i,1); applySettings(); renderCdSettings(); renderCd(); };

        function updateClock() {
            const n = new Date();
            $('h').innerText=String(n.getHours()).padStart(2,'0'); $('m').innerText=String(n.getMinutes()).padStart(2,'0'); $('s').innerText=String(n.getSeconds()).padStart(2,'0');
            $('date-display').innerText = n.toLocaleDateString();
        }
        
        init();
    </script>
</body>
</html>
